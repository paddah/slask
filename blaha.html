<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lat/Lon i realtid</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e6edf3; --muted:#9aa6b2; --card:#111826; --accent:#4da3ff; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .wrap{max-width:720px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{appearance:none;border:1px solid #2b3a55;background:#162237;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#04121f}
    button:disabled{opacity:.6;cursor:not-allowed}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:15px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px 16px;margin-top:8px}
    .label{color:var(--muted)}
    .value{font-variant-numeric:tabular-nums lining-nums}
    .ok{color:#62d392}
    .warn{color:#ffd166}
    .err{color:#ff6b6b}
    .foot{color:var(--muted);font-size:13px;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Lat/Lon i realtid <small id="dbgCount" style="font-size:12px;color:#9aa6b2;margin-left:8px"></small></h1>
      <div class="row">
        <button id="start" class="primary">Starta mätning</button>
        <button id="stop" disabled>Stoppa</button>
        <button id="copy" disabled>Kopiera värden</button>
        <span id="status" class="warn">Vänta: kräver plats-tillstånd</span>
      </div>
      <div class="kv">
        <div class="label">Latitud</div><div class="value"><code id="lat">–</code></div>
        <div class="label">Longitud</div><div class="value"><code id="lon">–</code></div>
        <div class="label">Noggrannhet (m)</div><div class="value"><code id="acc">–</code></div>
        <div class="label">Höjd (m)</div><div class="value"><code id="alt">–</code></div>
        <div class="label">Höjd‑noggr. (m)</div><div class="value"><code id="altacc">–</code></div>
        <div class="label">Fart (m/s)</div><div class="value"><code id="spd">–</code></div>
        <div class="label">Riktning (°)</div><div class="value"><code id="head">–</code></div>
        <div class="label">Senast uppdaterad</div><div class="value"><code id="ts">–</code></div>
      </div>
      <div class="foot">Tips: Kör över <strong>https</strong> (eller <code>localhost</code>) för att plats ska fungera. iOS kräver oftast ett knapptryck för att begära tillstånd.</div>
    </div>
  </div>

  <script>
    const ui = {
      start: document.getElementById('start'),
      stop: document.getElementById('stop'),
      copy: document.getElementById('copy'),
      status: document.getElementById('status'),
      lat: document.getElementById('lat'),
      lon: document.getElementById('lon'),
      acc: document.getElementById('acc'),
      alt: document.getElementById('alt'),
      altacc: document.getElementById('altacc'),
      spd: document.getElementById('spd'),
      head: document.getElementById('head'),
      ts: document.getElementById('ts'),
      dbgCount: document.getElementById('dbgCount'),
    };

    let watchId = null;
    let pollId = null; // fallback-polling
    let last = null;
    let updates = 0;

    function fmt(num, dec=7) {
      return (typeof num === 'number' && isFinite(num)) ? num.toFixed(dec) : '–';
    }

    function setStatus(text, cls) {
      ui.status.textContent = text;
      ui.status.className = cls || '';
    }

    function bumpCounter(){
      updates++;
      ui.dbgCount.textContent = `(uppdateringar: ${updates})`;
    }

    function onPos(pos){
      const c = pos.coords;
      last = {
        lat: c.latitude,
        lon: c.longitude,
        acc: c.accuracy,
        alt: c.altitude,
        altacc: c.altitudeAccuracy,
        spd: c.speed,
        head: c.heading,
        ts: pos.timestamp
      };
      ui.lat.textContent = fmt(c.latitude, 7); // ~1.1 cm vid 7 dec
      ui.lon.textContent = fmt(c.longitude, 7);
      ui.acc.textContent = fmt(c.accuracy, 1);
      ui.alt.textContent = c.altitude == null ? '–' : fmt(c.altitude, 2);
      ui.altacc.textContent = c.altitudeAccuracy == null ? '–' : fmt(c.altitudeAccuracy, 1);
      ui.spd.textContent = c.speed == null ? '–' : fmt(c.speed, 2);
      ui.head.textContent = c.heading == null ? '–' : fmt(c.heading, 0);
      ui.ts.textContent = new Date(pos.timestamp).toLocaleString();
      bumpCounter();
      setStatus('Aktiv – uppdaterar i realtid', 'ok');
      console.debug('[geo] update', last);
    }

    function onErr(err){
      console.error('[geo] error', err);
      // Visa tydlig orsak
      const map = {
        1: 'Plats nekades – tillåt i webbläsaren',
        2: 'Position otillgänglig – testa utomhus',
        3: 'Tidsgräns – försök igen',
      };
      setStatus(map[err.code] || (err.message || 'Platsfel'), 'err');
    }

    function start(){
      if (!('geolocation' in navigator)) {
        setStatus('Den här webbläsaren saknar geolokalisering', 'err');
        return;
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        setStatus('Måste köras över HTTPS eller localhost', 'err');
        return;
      }
      if (watchId !== null) return;
      setStatus('Begär plats…', 'warn');
      // Primär: kontinuerliga uppdateringar
      watchId = navigator.geolocation.watchPosition(onPos, onErr, {
        enableHighAccuracy: true,
        maximumAge: 1000,   // tillåt upp till 1 s cache
        timeout: 20000
      });
      // Fallback: polling med getCurrentPosition om watchPosition stagnerar på vissa desktop
      pollId = setInterval(() => {
        navigator.geolocation.getCurrentPosition(onPos, (e)=>{
          console.debug('[geo] poll error', e);
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
      }, 2000);
      ui.start.disabled = true;
      ui.stop.disabled = false;
      ui.copy.disabled = false;
    }

    function stop(){
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (pollId !== null) {
        clearInterval(pollId);
        pollId = null;
      }
      setStatus('Pausad', 'warn');
      ui.start.disabled = false;
      ui.stop.disabled = true;
    }

    async function copy(){
      if (!last) return;
      const text = `lat=${last.lat}\nlon=${last.lon}\nacc=${last.acc} m\nalt=${last.alt ?? 'n/a'} m\naltAcc=${last.altacc ?? 'n/a'} m\nspeed=${last.spd ?? 'n/a'} m/s\nheading=${last.head ?? 'n/a'}°\nwhen=${new Date(last.ts).toISOString()}`;
      try {
        await navigator.clipboard.writeText(text);
        setStatus('Kopierat till urklipp', 'ok');
        setTimeout(()=> setStatus('Aktiv – uppdaterar i realtid', 'ok'), 1200);
      } catch (e) {
        setStatus('Kunde inte kopiera', 'err');
      }
    }

    ui.start.addEventListener('click', start);
    ui.stop.addEventListener('click', stop);
    ui.copy.addEventListener('click', copy);

    // Försök autostarta om sidan återaktiveras och tidigare var igång
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible' && watchId === null && ui.start.disabled) {
        start();
      }
    });
  </script>
</body>
</html>
