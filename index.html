<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lat/Lon i realtid</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e6edf3; --muted:#9aa6b2; --card:#111826; --accent:#4da3ff; }
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    .wrap{max-width:720px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{appearance:none;border:1px solid #2b3a55;background:#162237;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#04121f}
    button:disabled{opacity:.6;cursor:not-allowed}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:15px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:10px 16px;margin-top:8px}
    .label{color:var(--muted)}
    .value{font-variant-numeric:tabular-nums lining-nums}
    .ok{color:#62d392}
    .warn{color:#ffd166}
    .err{color:#ff6b6b}
    .foot{color:var(--muted);font-size:13px;margin-top:12px}
    .helpbox{margin-top:16px;padding:12px;border:1px solid #444;border-radius:12px;background:#1b2535;color:#ffd166;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Lat/Lon i realtid <small id="dbgCount" style="font-size:12px;color:#9aa6b2;margin-left:8px"></small></h1>
      <div class="row">
        <button id="start" class="primary">Starta mätning</button>
        <button id="stop" disabled>Stoppa</button>
        <button id="copy" disabled>Kopiera värden</button>
        <span id="status" class="warn">Vänta: kräver plats-tillstånd</span>
      </div>
      <div class="row" id="permRow" style="display:none">
        <span class="label">Tillstånd</span>
        <code id="perm">okänt</code>
      </div>
      <div class="kv">
        <div class="label">Secure context</div><div class="value"><code id="secure">–</code></div>
        <div class="label">Origin</div><div class="value"><code id="origin">–</code></div>
        <div class="label">Latitud</div><div class="value"><code id="lat">–</code></div>
        <div class="label">Longitud</div><div class="value"><code id="lon">–</code></div>
        <div class="label">Noggrannhet (m)</div><div class="value"><code id="acc">–</code></div>
        <div class="label">Höjd (m)</div><div class="value"><code id="alt">–</code></div>
        <div class="label">Höjd‑noggr. (m)</div><div class="value"><code id="altacc">–</code></div>
        <div class="label">Fart (m/s)</div><div class="value"><code id="spd">–</code></div>
        <div class="label">Riktning (°)</div><div class="value"><code id="head">–</code></div>
        <div class="label">Senast uppdaterad</div><div class="value"><code id="ts">–</code></div>
      </div>
      <div id="help" class="helpbox"></div>
      <div class="foot">Tips: Kör över <strong>https</strong> (eller <code>localhost</code>) för att plats ska fungera. iOS kräver att <em>första</em> anropet sker direkt i knapptrycket. Om du råkat neka: Inställningar ➜ Integritet & säkerhet ➜ Platstjänster ➜ <em>Safari-webbplatser</em> → "När appen används" och slå på "Exakt plats".</div>
    </div>
  </div>

  <script>
    const ui = {
      start: document.getElementById('start'),
      stop: document.getElementById('stop'),
      copy: document.getElementById('copy'),
      status: document.getElementById('status'),
      lat: document.getElementById('lat'),
      lon: document.getElementById('lon'),
      acc: document.getElementById('acc'),
      alt: document.getElementById('alt'),
      altacc: document.getElementById('altacc'),
      spd: document.getElementById('spd'),
      head: document.getElementById('head'),
      ts: document.getElementById('ts'),
      dbgCount: document.getElementById('dbgCount'),
      perm: document.getElementById('perm'),
      permRow: document.getElementById('permRow'),
      secure: document.getElementById('secure'),
      origin: document.getElementById('origin'),
      help: document.getElementById('help')
    };

    let watchId = null;
    let last = null;
    let updates = 0;

    function fmt(num, dec=7) {
      return (typeof num === 'number' && isFinite(num)) ? num.toFixed(dec) : '–';
    }

    function setStatus(text, cls) {
      ui.status.textContent = text;
      ui.status.className = cls || '';
    }

    function bumpCounter(){
      updates++;
      ui.dbgCount.textContent = `(uppdateringar: ${updates})`;
    }

    function onPos(pos){
      const c = pos.coords;
      last = {
        lat: c.latitude,
        lon: c.longitude,
        acc: c.accuracy,
        alt: c.altitude,
        altacc: c.altitudeAccuracy,
        spd: c.speed,
        head: c.heading,
        ts: pos.timestamp
      };
      ui.lat.textContent = fmt(c.latitude, 7);
      ui.lon.textContent = fmt(c.longitude, 7);
      ui.acc.textContent = fmt(c.accuracy, 1);
      ui.alt.textContent = c.altitude == null ? '–' : fmt(c.altitude, 2);
      ui.altacc.textContent = c.altitudeAccuracy == null ? '–' : fmt(c.altitudeAccuracy, 1);
      ui.spd.textContent = c.speed == null ? '–' : fmt(c.speed, 2);
      ui.head.textContent = c.heading == null ? '–' : fmt(c.heading, 0);
      ui.ts.textContent = new Date(pos.timestamp).toLocaleString();
      bumpCounter();
      setStatus('Aktiv – uppdaterar i realtid', 'ok');
    }

    function onErr(err){
      console.error('[geo] error', err);
      setStatus(err.message || 'Platsfel', 'err');
      if(err.code===1){
        ui.help.style.display='block';
        ui.help.innerHTML = `<strong>Så här aktiverar du plats för denna sida:</strong><ul>
          <li>I Safari: tryck <em>aA</em> vid adressfältet → Webbplatsinställningar → Plats: Tillåt</li>
          <li>Eller gå till Inställningar → Safari → Inställningar för webbplatser → Plats, hitta din sida och välj Tillåt</li>
          <li>Om du lagt till sidan på hemskärmen: Inställningar → Integritet & säkerhet → Platstjänster → leta efter din Web App och välj När appen används + Exakt plats</li>
        </ul>`;
      }
    }

    ui.start.addEventListener('click', () => {
      if (!('geolocation' in navigator)) {
        setStatus('Den här webbläsaren saknar geolokalisering', 'err');
        return;
      }
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        setStatus('Måste köras över HTTPS eller localhost', 'err');
        return;
      }
      if (watchId !== null) return;

      setStatus('Begär plats…', 'warn');

      // iOS-säkert: första getCurrentPosition direkt i klicket
      navigator.geolocation.getCurrentPosition((first)=>{
        onPos(first);
        // Starta kontinuerlig bevakning
        watchId = navigator.geolocation.watchPosition(onPos, onErr, {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 20000
        });
        ui.start.disabled = true;
        ui.stop.disabled = false;
        ui.copy.disabled = false;
      }, onErr, { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 });
    });

    ui.stop.addEventListener('click', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      setStatus('Pausad', 'warn');
      ui.start.disabled = false;
      ui.stop.disabled = true;
    });

    ui.copy.addEventListener('click', async () => {
      if (!last) return;
      const text = `lat=${last.lat}\nlon=${last.lon}\nacc=${last.acc} m\nalt=${last.alt ?? 'n/a'} m\naltAcc=${last.altacc ?? 'n/a'} m\nspeed=${last.spd ?? 'n/a'} m/s\nheading=${last.head ?? 'n/a'}°\nwhen=${new Date(last.ts).toISOString()}`;
      try {
        await navigator.clipboard.writeText(text);
        setStatus('Kopierat till urklipp', 'ok');
        setTimeout(()=> setStatus('Aktiv – uppdaterar i realtid', 'ok'), 1200);
      } catch (e) {
        setStatus('Kunde inte kopiera', 'err');
      }
    });

    function showEnv(){
      ui.secure.textContent = window.isSecureContext ? 'ja' : 'nej';
      ui.origin.textContent = location.origin;
    }

    showEnv();
  </script>
</body>
</html>
