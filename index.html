<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dingbat Killer ‚Äî Browser Multiplayer</title>
  <style>
    :root {
      --bg:#0b0f14; --fg:#e9eef5; --muted:#94a3b8; --accent:#64d2ff; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --card:#121821; --btn:#1f2937; --btn2:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:720px;margin:0 auto;padding:20px 16px 60px}
    h1{font-size:24px;margin:16px 0}
    h2{font-size:18px;margin:16px 0 8px;color:var(--accent)}
    p,small,label{color:var(--muted)}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input{width:100%;background:#0f172a;color:var(--fg);border:1px solid #1f2737;border-radius:10px;padding:12px;font-size:16px}
    button{appearance:none;border:0;padding:12px 16px;border-radius:12px;background:var(--btn);color:var(--fg);font-size:16px;cursor:pointer}
    button.primary{background:var(--accent);color:#001219;font-weight:700}
    button.ghost{background:var(--btn2)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:#0f172a;border:1px solid #243447}
    .metric{font-size:28px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:#1f2937;margin:16px 0}
    .center{text-align:center}
    .hint{font-size:13px;color:var(--muted)}
    .compass{width:140px;height:140px;border-radius:50%;border:2px solid #223046;margin:8px auto;position:relative}
    .needle{position:absolute;left:50%;top:50%;width:2px;height:52%;background:var(--accent);transform-origin:bottom center;transform:translate(-50%,-100%) rotate(0deg)}
    .northDot{position:absolute;width:8px;height:8px;background:var(--bad);border-radius:50%;left:50%;top:4px;transform:translateX(-50%)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;border:1px solid #243447;color:var(--fg);padding:10px 14px;border-radius:999px;font-size:14px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üïπÔ∏è Dingbat Killer</h1>
    <p>No-install, phone-friendly multiplayer. Create or join with a <b>Game ID</b>, share your location, and the <b>server</b> handles all rules (kill distance, deaths, winner).</p>

    <!-- Screens -->
    <div id="screen-welcome" class="card">
      <h2>Start</h2>
      <div class="grid-2">
        <button id="btn-new" class="primary">Create new game</button>
        <button id="btn-join" class="ghost">Join a game</button>
      </div>
      <div class="divider"></div>
      <details>
        <summary>iPhone location tips</summary>
        <ul class="hint">
          <li>Use Safari over <b>HTTPS</b> (e.g., GitHub Pages).</li>
          <li>Tap <b>Start tracking</b> once you‚Äôre in the game (user gesture required on iOS).</li>
          <li>Safari ‚Üí aA ‚Üí Website Settings ‚Üí Location: <b>Allow</b>.</li>
          <li>Settings ‚Üí Safari ‚Üí Location: <b>While Using</b>.</li>
        </ul>
      </details>
    </div>

    <div id="screen-new" class="card" hidden>
      <h2>New game</h2>
      <label>Host name
        <input id="new-host" placeholder="e.g. Anneli" autocomplete="name" />
      </label>
      <div class="row">
        <button id="create" class="primary">Create</button>
        <button class="ghost" data-back>Back</button>
      </div>
    </div>

    <div id="screen-join" class="card" hidden>
      <h2>Join game</h2>
      <div class="grid-2">
        <label>Your name
          <input id="join-name" placeholder="e.g. Ragnar" autocomplete="name" />
        </label>
        <label>Game ID
          <input id="join-id" placeholder="e.g. 1" class="mono" />
        </label>
      </div>
      <div class="row">
        <button id="join" class="primary">Join</button>
        <button class="ghost" data-back>Back</button>
      </div>
    </div>

    <div id="screen-lobby" class="card" hidden>
      <h2>Lobby</h2>
      <p>Share this Game ID with your friends:</p>
      <div class="row">
        <div class="pill mono" id="lobby-id">‚Äî</div>
        <button id="copy-id">Copy</button>
      </div>
      <div class="divider"></div>
      <div id="players" class="hint">Waiting for players‚Ä¶</div>
      <div class="divider"></div>
      <button id="start-game" class="primary">Start game</button>
    </div>

    <div id="screen-game" class="card" hidden>
      <h2>Status</h2>
      <div class="grid-2">
        <div class="card">
          <div class="metric" id="dist-target">‚Äî</div>
          <div class="sub">Distance to target</div>
        </div>
        <div class="card">
          <div class="metric" id="dist-killer">‚Äî</div>
          <div class="sub">Distance to your killer</div>
        </div>
      </div>

      <div class="compass">
        <div class="northDot"></div>
        <div class="needle" id="needle"></div>
      </div>
      <div class="center hint">Needle points toward your <b>target</b>.</div>

      <div class="divider"></div>
      <div class="grid-2">
        <div>
          <p class="sub">You</p>
          <div class="mono" id="you-pos">‚Äî</div>
        </div>
        <div>
          <p class="sub">Target last seen</p>
          <div class="mono" id="tgt-pos">‚Äî</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="grid-2">
        <div>Game state: <span id="gamestate" class="pill">‚Äî</span></div>
        <div>Kill distance: <span id="killdistance" class="pill">‚Äî</span></div>
      </div>

      <div class="divider"></div>
      <div class="row">
        <button id="btn-track" class="ghost">Start tracking</button>
      </div>
      <small class="hint">Server decides kills/winner. Just move; we handle the rest.</small>
    </div>

    <div id="screen-winner" class="card center" hidden>
      <h2>üèÜ Winner!</h2>
      <p>You‚Äôre the champion.</p>
      <button data-reset>Play again</button>
    </div>

    <div id="screen-loser" class="card center" hidden>
      <h2>üòµ Eliminated</h2>
      <p>Better luck next time.</p>
      <button data-reset>Play again</button>
    </div>

    <div id="screen-end" class="card center" hidden>
      <h2>Game over</h2>
      <p id="end-msg">Thanks for playing.</p>
      <button data-reset>New game</button>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
  (() => {
    // ====== CONFIG (dingbat server) ======
    const API_BASE = "https://api.dingbat.se"; // <- using your backend

    const API = {
      newgame:   () => `${API_BASE}/newgame`,
      newplayer: (gid) => `${API_BASE}/game/${encodeURIComponent(gid)}/newplayer`,
      startgame: (gid) => `${API_BASE}/game/${encodeURIComponent(gid)}/startgame`,
      state:     (gid) => `${API_BASE}/game/${encodeURIComponent(gid)}`,
      update:    (gid, pid) => `${API_BASE}/game/${encodeURIComponent(gid)}/${encodeURIComponent(pid)}`
    };

    // ====== Small utilities ======
    const $ = s => document.querySelector(s);
    const show = id => document.querySelectorAll('[id^="screen-"]').forEach(x => x.hidden = x.id !== id);
    const toast = (msg, ms=1800) => { const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); };
    const toFixed = (n,p=1)=> (isFinite(n)? n.toFixed(p) : "‚Äî");
    const degToRad = d=> d*Math.PI/180, radToDeg = r=> r*180/Math.PI;

    const haversine = (a,b) => {
      const R=6371000, dLat=degToRad(b.lat-a.lat), dLon=degToRad(b.lon-a.lon);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const aa=s1*s1 + Math.cos(degToRad(a.lat))*Math.cos(degToRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(aa));
    };
    const bearing = (a,b) => {
      const œÜ1=degToRad(a.lat), œÜ2=degToRad(b.lat), Œª1=degToRad(a.lon), Œª2=degToRad(b.lon), dŒª=Œª2-Œª1;
      const y=Math.sin(dŒª)*Math.cos(œÜ2);
      const x=Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(dŒª);
      return (radToDeg(Math.atan2(y,x))+360)%360;
    };

    // ====== App state ======
    const state = {
      gameId:null,
      playerId:null,
      name:null,
      pollTimer:null,
      trackId:null,
      lastHeading:0,
      you:{}, players:{}, killdistance:null, gamestate:""
    };

    // ====== DOM ======
    const els = {
      // welcome
      btnNew: $("#btn-new"),
      btnJoin: $("#btn-join"),
      // new
      newHost: $("#new-host"),
      create: $("#create"),
      // join
      joinName: $("#join-name"),
      joinId: $("#join-id"),
      joinBtn: $("#join"),
      // lobby
      lobbyId: $("#lobby-id"),
      copyId: $("#copy-id"),
      players: $("#players"),
      startGame: $("#start-game"),
      // game
      distTarget: $("#dist-target"),
      distKiller: $("#dist-killer"),
      youPos: $("#you-pos"),
      tgtPos: $("#tgt-pos"),
      killdistance: $("#killdistance"),
      gamestate: $("#gamestate"),
      btnTrack: $("#btn-track"),
      needle: $("#needle"),
      // end
      endMsg: $("#end-msg")
    };

    // ====== Nav handlers ======
    document.body.addEventListener("click", (e) => {
      const back = e.target.closest("[data-back]");
      const reset = e.target.closest("[data-reset]");
      if (back) show("screen-welcome");
      if (reset) location.reload();
    });

    // ====== Welcome ======
    els.btnNew.addEventListener("click", () => show("screen-new"));
    els.btnJoin.addEventListener("click", () => show("screen-join"));

    // ====== Create new game (then add host as a player) ======
    els.create.addEventListener("click", async () => {
      const hostName = (els.newHost.value || "").trim();
      if (!hostName) return toast("Enter host name");
      try {
        // Server demands a name; commonly ‚Äúgurk‚Äù
        const res =
